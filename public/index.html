<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.sheetjs.com;
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com;
        font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com https://r2cdn.perplexity.ai;
        connect-src 'self' https://*.supabase.co wss://*.supabase.co https://cdn.jsdelivr.net;
        img-src 'self' data:;
    ">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESCON 360 - Sistema Integral de Gestión de Expedientes</title>
    <link rel="icon" href="logo.png" type="image/png">

    <!-- Enlaces a recursos externos (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        
    <!-- SheetJS para parseo de CSV/Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ENLACE A TU ARCHIVO CSS -->
    <link rel="stylesheet" href="style.css">

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Debug Console - OCULTO POR DEFECTO -->
    <div id="debugConsole"></div>

    <!-- Visual Debugger - OCULTO POR DEFECTO -->
    <div id="visualDebugger"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <img src="logo.png" alt="Logo Gescon360" class="auth-logo">
                <h2>GESCON 360</h2>
                <p class="text-muted">Sistema de Gestión de Expedientes</p>
            </div>

            <div id="loginAlert" class="alert-custom alert-warning" style="display: none;">
                <i class="bi bi-exclamation-triangle"></i>
                <span>No hay usuarios registrados. Debe crear una cuenta de administrador para comenzar.</span>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail" class="form-label">Correo Electrónico</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                        <input id="loginEmail" type="email" class="form-control" placeholder="tu.email@gescon360.es" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="loginPassword" class="form-label">Código de Seguridad</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock"></i></span>
                        <input id="loginPassword" type="text" class="form-control" placeholder="Escribe el código" required>
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">
                        Recordarme
                    </label>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn-custom btn-primary-custom" id="loginButton">
                        <span id="loginButtonText">Iniciar Sesión</span>
                        <span id="loginSpinner" class="loading d-none"></span>
                    </button>

                    <!-- Botón temporal de registro (deshabilitado por seguridad) -->
                    <button type="button" class="btn-custom btn-outline-custom mt-2 w-100" id="createAdminButton" disabled
                            title="La creación de usuarios admin desde el cliente está deshabilitada por seguridad.">
                        Crear Usuario Admin (DESHABILITADO)
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="appContainer" class="d-none">
        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" onclick="toggleSidebar()">
            <i class="bi bi-list"></i>
        </button>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="Logo Gescon360" class="sidebar-logo">
                <h3>GESCON 360</h3>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showSection('dashboard')"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li><a href="#" onclick="showSection('import')"><i class="bi bi-upload"></i> Importar Expedientes</a></li>
                <li><a href="#" onclick="showSection('tasks')"><i class="bi bi-list-task"></i> Gestión de Tareas</a></li>
                <li><a href="#" onclick="showSection('duplicates')"><i class="bi bi-exclamation-triangle"></i> Duplicados</a></li>
                <li><a href="#" onclick="showSection('reports')"><i class="bi bi-graph-up"></i> Reportes</a></li>
                <li><a href="#" onclick="showSection('archive')"><i class="bi bi-archive"></i> Archivados</a></li>
                <li><a href="#" onclick="showSection('config')"><i class="bi bi-gear"></i> Configuración</a></li>
            </ul>

            <div class="admin-section">
                <div class="sidebar-header">
                    <h4><i class="bi bi-shield-lock"></i> Administración</h4>
                </div>
                <ul class="sidebar-menu">
                    <li><a href="#" onclick="showSection('admin')"><i class="bi bi-people"></i> Gestión de Responsables<span class="admin-badge">ADMIN</span></a></li>
                    <li><a href="#" onclick="showSection('workload')"><i class="bi bi-bar-chart"></i> Distribución de Carga<span class="admin-badge">ADMIN</span></a></li>
                    <li><a href="#" onclick="showSection('limits')"><i class="bi bi-sliders"></i> Límites del Sistema<span class="admin-badge">ADMIN</span></a></li>
                    <li><a href="#" onclick="showSection('users')"><i class="bi bi-person-gear"></i> Gestión de Usuarios<span class="admin-badge">ADMIN</span></a></li>
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar con Logo -->
            <div class="top-bar">
                <div class="logo-link">
                    <!-- RUTA CORREGIDA DEL LOGO -->
                    <img src="logo.png" alt="Logo Gescon360" class="logo-img">
                    <span class="logo-text">GESCON 360</span>
                </div>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <div class="notification-icon" onclick="showNotifications()">
                        <i class="bi bi-bell"></i>
                        <span class="notification-badge">3</span>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-custom dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> <span id="userName">Usuario</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-person"></i> Perfil</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear"></i> Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="row">
                    <div class="col-12">
                        <div class="dashboard-card">
                            <div class="card-header-custom">
                                <h5 class="card-title">Búsqueda de Expedientes</h5>
                                <div class="card-icon icon-primary">
                                    <i class="bi bi-search"></i>
                                </div>
                            </div>

                            <div class="search-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="searchExpedient" class="form-label">Nº Expediente</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-file-earmark-text"></i></span>
                                            <input id="searchExpedient" type="text" class="form-control" placeholder="Ej: EXP-2024-001">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="searchPolicy" class="form-label">Nº Póliza</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-card-text"></i></span>
                                            <input id="searchPolicy" type="text" class="form-control" placeholder="Ej: POL-123456">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="searchSGR" class="form-label">Nº SGR</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-building"></i></span>
                                            <input id="searchSGR" type="text" class="form-control" placeholder="Ej: SGR-001234">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="searchDNI" class="form-label">DNI</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                                            <input id="searchDNI" type="text" class="form-control" placeholder="Ej: 12345678Z">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <button class="btn-custom btn-primary-custom" onclick="searchExpedients()">
                                                    <i class="bi bi-search"></i> Buscar
                                                </button>
                                                <button class="btn-custom btn-outline-custom" onclick="clearSearch()">
                                                    <i class="bi bi-x-circle"></i> Limpiar
                                                </button>
                                            </div>
                                            <div>
                                                <button class="btn-custom btn-outline-custom" onclick="advancedSearch()">
                                                    <i class="bi bi-sliders"></i> Búsqueda Avanzada
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resultados de Búsqueda -->
                <div class="row mt-4" id="searchResults" style="display: none;">
                    <div class="col-12">
                        <div class="custom-table">
                            <div class="table-header">
                                <h5 class="table-title">Resultados de Búsqueda</h5>
                                <div class="table-actions">
                                    <span class="text-muted" id="resultCount">0 resultados encontrados</span>
                                </div>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>N° Expediente</th>
                                            <th>N° Póliza</th>
                                            <th>N° SGR</th>
                                            <th>Cliente</th>
                                            <th>DNI</th>
                                            <th>Estado</th>
                                            <th>Fecha Vencimiento</th>
                                            <th>Importe</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="searchResultsTable">
                                        <!-- Los resultados se cargarán aquí -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas Rápidas -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="dashboard-card">
                            <div class="card-header-custom">
                                <h5 class="card-title">Total Expedientes</h5>
                                <div class="card-icon icon-primary">
                                    <i class="bi bi-folder"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalExpedients">0</div>
                            <div class="stat-label">Activos en sistema</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="dashboard-card">
                            <div class="card-header-custom">
                                <h5 class="card-title">Pendientes</h5>
                                <div class="card-icon icon-warning">
                                    <i class="bi bi-clock"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="pendingExpedients">0</div>
                            <div class="stat-label">Por procesar</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="dashboard-card">
                            <div class="card-header-custom">
                                <h5 class="card-title">En Proceso</h5>
                                <div class="card-icon icon-success">
                                    <i class="bi bi-arrow-repeat"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="processExpedients">0</div>
                            <div class="stat-label">Activos</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="dashboard-card">
                            <div class="card-header-custom">
                                <h5 class="card-title">Vencimientos Hoy</h5>
                                <div class="card-icon icon-danger">
                                    <i class="bi bi-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="dueTodayExpedients">0</div>
                            <div class="stat-label">Urgentes</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Import Section -->
            <section id="import" class="content-section">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h5 class="card-title">Importar Expedientes</h5>
                        <div class="card-icon icon-primary">
                            <i class="bi bi-upload"></i>
                        </div>
                    </div>

                    <div class="alert-custom alert-warning">
                        <i class="bi bi-info-circle"></i>
                        <span>Seleccione un archivo CSV o Excel con los expedientes a importar. El sistema validará automáticamente la estructura y detectará duplicados.</span>
                    </div>

                    <div class="file-upload-container" id="fileUploadContainer">
                        <div class="file-upload-icon">
                            <i class="bi bi-cloud-upload"></i>
                        </div>
                        <div class="file-upload-text">
                            Arrastra y suelta el archivo aquí o haz clic para seleccionarlo
                        </div>
                        <div class="file-upload-hint">
                            Tamaño máximo: 10 MB | Formatos: CSV, XLS, XLSX
                        </div>
                        <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display: none;">
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-name" id="fileName">-</div>
                            <div class="file-size" id="fileSize">-</div>
                        </div>
                        <div class="file-progress" id="fileProgress">
                            <div class="file-progress-bar" id="fileProgressBar"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Opciones de Importación</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="validateDuplicates" checked>
                            <label class="form-check-label" for="validateDuplicates">
                                Verificar duplicados automáticamente
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="normalizeFields" checked>
                            <label class="form-check-label" for="normalizeFields">
                                Normalizar campos automáticamente
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoTransfer" checked>
                            <label class="form-check-label" for="autoTransfer">
                                Traspasar y distribuir automáticamente en tareas
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoDistributeImport" checked>
                            <label class="form-check-label" for="autoDistributeImport">
                                Distribuir equitativamente entre responsables activos
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn-custom btn-primary-custom" onclick="importarExpedientes()">
                            <i class="bi bi-upload"></i> Importar Expedientes
                        </button>
                    </div>
                </div>

                <!-- Import Log -->
                <div class="custom-table mt-4">
                    <div class="table-header">
                        <h5 class="table-title">Registro de Importaciones</h5>
                        <div class="table-actions">
                            <input type="date" id="importLogDateFilter" class="form-control form-control-sm d-inline-block w-auto me-2" onchange="loadImportLogs()" title="Filtrar por fecha">
                            <button class="btn-custom btn-outline-custom" onclick="exportImportLogsToExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Exportar Historial
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Archivo</th>
                                    <th>Registros</th>
                                    <th>Estado</th>
                                    <th>Duplicados</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="importLogTable">
                                <!-- Los registros de importación se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Tasks Section -->
            <section id="tasks" class="content-section">
                <div class="alert-custom alert-urgent" id="urgentAlert" style="display: none;">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span><strong>Atención:</strong> Hay tareas urgentes que vencen hoy. Se han enviado notificaciones por email.</span>
                </div>

                <div class="custom-table">
                    <div class="table-header">
                        <h5 class="table-title">Gestión de Tareas</h5>
                        <div class="table-actions">
                            <div class="input-group input-group-sm me-2" style="width: 250px; display: inline-flex;">
                                <input type="text" class="form-control" id="taskSearchInput" placeholder="Buscar Nº o descripción..." onkeyup="if(event.key === 'Enter') searchTasks()">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchTasks()"><i class="bi bi-search"></i></button>
                            </div>
                            <button class="btn-custom btn-outline-custom" onclick="filterTasks()">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                            <button class="btn-custom btn-primary-custom" onclick="addNewTask()">
                                <i class="bi bi-plus"></i> Nueva Tarea
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>N° Expediente</th>
                                    <th>Ref. Gescon</th>
                                    <th>N° SGR</th>
                                    <th>Descripción</th>
                                    <th>Responsable</th>
                                    <th>Estado</th>
                                    <th>Prioridad</th>
                                    <th>Fecha Límite</th>
                                    <th>Importe Recobrado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTable">
                                <!-- Tasks will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Duplicates Section -->
            <section id="duplicates" class="content-section">
                <div class="alert-custom alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span><strong>Sección de Duplicados:</strong> Los expedientes duplicados se almacenan aquí para su revisión. Puede eliminarlos, mantenerlos o procesarlos manualmente.</span>
                </div>

                <div class="custom-table">
                    <div class="table-header">
                        <h5 class="table-title">Expedientes Duplicados Detectados</h5>
                        <div class="table-actions">
                            <button class="btn-custom btn-outline-custom" onclick="processAllDuplicates()" title="Fusionar la información de los duplicados con los expedientes originales">
                                <i class="bi bi-check-circle"></i> Procesar Todos
                            </button>
                            <button class="btn-custom btn-outline-danger" onclick="deleteAllDuplicates()" title="Borrar permanentemente estos registros de duplicados (no afecta a los originales)">
                                <i class="bi bi-trash"></i> Eliminar Todos
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllDuplicates"></th>
                                    <th>N° Expediente</th>
                                    <th>N° SGR</th>
                                    <th>Cliente</th>
                                    <th>Fecha Detección</th>
                                    <th>Veces Repetido</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="duplicatesTable">
                                <!-- Duplicates will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Users Management Section -->
            <section id="users" class="content-section">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h5 class="card-title">Gestión de Usuarios</h5>
                        <div class="card-icon icon-primary">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>

                    <div class="alert-custom alert-warning">
                        <i class="bi bi-shield-lock"></i>
                        <span>Sección de administración. Solo usuarios con privilegios pueden modificar esta información.</span>
                    </div>

                    <div class="table-actions mb-3">
                        <button class="btn-custom btn-primary-custom" onclick="addUser()">
                            <i class="bi bi-plus"></i> Añadir Usuario
                        </button>
                    </div>

                    <div class="custom-table">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Rol</th>
                                        <th>Estado</th>
                                        <th>Fecha Registro</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin Section -->
            <section id="admin" class="content-section">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h5 class="card-title">Gestión de Responsables</h5>
                        <div class="card-icon icon-primary">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>

                    <div class="alert-custom alert-warning">
                        <i class="bi bi-shield-lock"></i>
                        <span>Sección de administración. Solo usuarios con privilegios pueden modificar esta información.</span>
                    </div>

                    <div class="table-actions mb-3">
                        <button class="btn-custom btn-primary-custom" onclick="addResponsible()" title="Registrar un nuevo gestor en el sistema">
                            <i class="bi bi-plus"></i> Añadir Responsable
                        </button>
                        <button class="btn-custom btn-outline-custom" onclick="distributeWorkload()" title="Repartir tareas de usuarios ausentes (baja/vacaciones) entre los activos">
                            <i class="bi bi-arrow-repeat"></i> Distribuir Carga Equitativamente
                        </button>
                        <button class="btn-custom btn-outline-custom" onclick="rebalanceActiveWorkload()" title="Nivelar la carga de trabajo moviendo tareas de usuarios saturados a los que tienen menos">
                            <i class="bi bi-scales"></i> Rebalancear Carga Activa
                        </button>
                        <button class="btn-custom btn-outline-warning" onclick="openReassignTasksModal()" title="Transferir manualmente todas las tareas de un usuario a otro">
                            <i class="bi bi-arrow-left-right"></i> Reasignar Tareas
                        </button>
                    </div>

                    <div id="responsiblesList">
                        <!-- Responsible persons will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Workload Section -->
            <section id="workload" class="content-section">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h5 class="card-title">Distribución de Carga de Trabajo</h5>
                        <div class="card-icon icon-warning">
                            <i class="bi bi-bar-chart"></i>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <!-- This label is a group heading, keep as div to avoid unattached label warnings -->
                            <div class="form-label">Configuración de Distribución Automática</div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoDistribute" checked>
                                <label class="form-check-label" for="autoDistribute">
                                    Distribuir automáticamente nuevas tareas
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="considerWorkload" checked>
                                <label class="form-check-label" for="considerWorkload">
                                    Considerar carga actual de trabajo
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emailNotificationsWorkload" checked>
                                <label class="form-check-label" for="emailNotificationsWorkload">
                                    Enviar notificaciones por email
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="notificationEmails" class="form-label">Emails para Notificaciones</label>
                                <textarea class="form-control" id="notificationEmails" rows="4" placeholder="juan.perez@empresa.com&#10;maria.lopez@empresa.com&#10;carlos.rodriguez@empresa.com"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn-custom btn-outline-custom" onclick="resetWorkloadConfig()">
                            <i class="bi bi-arrow-counterclockwise"></i> Restablecer
                        </button>
                        <button class="btn-custom btn-primary-custom" onclick="saveWorkloadConfig()">
                            <i class="bi bi-check"></i> Guardar Configuración
                        </button>
                    </div>
                </div>

                <div class="custom-table mt-4">
                    <div class="table-header">
                        <h5 class="table-title">Resumen de Carga de Trabajo Actual</h5>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Responsable</th>
                                    <th>Estado</th>
                                    <th>Tareas Activas</th>
                                    <th>Tareas Completadas</th>
                                    <th>Carga de Trabajo</th>
                                    <th>Disponibilidad</th>
                                </tr>
                            </thead>
                            <tbody id="workloadTable">
                                <!-- Workload data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Limits Section -->
            <section id="limits" class="content-section">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h5 class="card-title">Configuración de Límites del Sistema</h5>
                        <div class="card-icon icon-warning">
                            <i class="bi bi-sliders"></i>
                        </div>
                    </div>

                    <div class="alert-custom alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span><strong>Precaución:</strong> Modificar estos límites puede afectar el rendimiento del sistema. Asegúrese de tener suficiente espacio de almacenamiento.</span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Límites de Archivos</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="maxFileSize" class="form-label">Tamaño Máximo de Archivo (MB)</label>
                                            <input id="maxFileSize" type="number" class="form-control" value="10" min="1" max="100">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="maxConcurrentFiles" class="form-label">Archivos Simultáneos</label>
                                            <input id="maxConcurrentFiles" type="number" class="form-control" value="5" min="1" max="20">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Límites de Registros</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="maxExpedientes" class="form-label">Máximo de Expedientes</label>
                                            <input id="maxExpedientes" type="number" class="form-control" value="5000" min="100" max="50000">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="maxActiveTasks" class="form-label">Máximo de Tareas Activas</label>
                                            <input id="maxActiveTasks" type="number" class="form-control" value="2000" min="100" max="20000">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Límites de Archivados</label>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="maxArchivedExpedients" class="form-label">Máximo de Expedientes Archivados</label>
                                            <input id="maxArchivedExpedients" type="number" class="form-control" value="10000" min="100" max="100000">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn-custom btn-outline-custom" onclick="resetLimits()">
                            <i class="bi bi-arrow-counterclockwise"></i> Restablecer Valores Predeterminados
                        </button>
                        <button class="btn-custom btn-primary-custom" onclick="saveLimits()">
                            <i class="bi bi-check"></i> Guardar Configuración
                        </button>
                    </div>
                </div>

                <div class="custom-table mt-4">
                    <div class="table-header">
                        <h5 class="table-title">Estado Actual del Sistema</h5>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Recurso</th>
                                    <th>Límite Configurado</th>
                                    <th>Uso Actual</th>
                                    <th>Porcentaje Utilizado</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="limitsTableBody">
                                <!-- El estado del sistema se cargará aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="content-section">
                <div class="dashboard-card mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0"><i class="bi bi-bar-chart-line"></i> Generación de Gráficos</h5>
                            <small class="text-muted">Los gráficos se generan bajo demanda para optimizar el rendimiento del sistema.</small>
                        </div>
                        <button class="btn-custom btn-primary-custom" onclick="loadReports()">
                            <i class="bi bi-play-fill"></i> Cargar Gráficos
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <h5 class="card-title">Estadísticas Mensuales</h5>
                            <canvas id="monthlyChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <h5 class="card-title">Distribución por Estado</h5>
                            <canvas id="statusChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <div class="custom-table mt-4">
                    <div class="table-header">
                        <h5 class="table-title">Reporte de Productividad</h5>
                        <div class="table-actions">
                            <button class="btn-custom btn-outline-custom" onclick="exportReport()">
                                <i class="bi bi-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Mes</th>
                                    <th>Expedientes Procesados</th>
                                    <th>Tiempo Promedio (días)</th>
                                    <th>Tasa de Éxito</th>
                                    <th>Importe Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Diciembre 2024</td>
                                    <td>45</td>
                                    <td>12.5</td>
                                    <td>92%</td>
                                    <td>€125,450.00</td>
                                </tr>
                                <tr>
                                    <td>Noviembre 2024</td>
                                    <td>52</td>
                                    <td>10.8</td>
                                    <td>88%</td>
                                    <td>€98,320.00</td>
                                </tr>
                                <tr>
                                    <td>Octubre 2024</td>
                                    <td>38</td>
                                    <td>14.2</td>
                                    <td>95%</td>
                                    <td>€156,780.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Archive Section -->
            <section id="archive" class="content-section">
                <div class="alert-custom alert-warning">
                    <i class="bi bi-info-circle"></i>
                    <span>Los expedientes archivados se conservan para consulta histórica pero no están activos en el flujo de trabajo actual.</span>
                </div>

                <div class="custom-table">
                    <div class="table-header">
                        <h5 class="table-title">Expedientes Archivados</h5>
                        <div class="table-actions">
                            <div class="input-group input-group-sm" style="width: 300px;">
                                <input type="text" class="form-control" id="archiveSearchInput" placeholder="Buscar por Nº, Cliente o SGR..." onkeyup="if(event.key === 'Enter') searchArchive()">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchArchive()"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>N° Expediente</th>
                                    <th>N° SGR</th>
                                    <th>Cliente</th>
                                    <th>Fecha Archivo</th>
                                    <th>Motivo</th>
                                    <th>Importe Final</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="archiveTableBody">
                                <!-- Los expedientes archivados se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Config Section -->
            <section id="config" class="content-section">
                <div class="dashboard-card">
                    <h5 class="card-title">Configuración del Sistema</h5>

                    <div class="form-group">
                        <label class="form-label">Configuración General</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="companyName" class="form-label">Nombre de la Empresa</label>
                                    <input id="companyName" type="text" class="form-control" value="GESCON 360">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dateFormat" class="form-label">Formato de Fecha</label>
                                    <select id="dateFormat" class="form-select">
                                        <option>DD/MM/YYYY</option>
                                        <option>MM/DD/YYYY</option>
                                        <option>YYYY-MM-DD</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Automatizaciones</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoReminders" checked>
                            <label class="form-check-label" for="autoReminders">
                                Enviar recordatorios automáticos de vencimientos
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoArchive" checked>
                            <label class="form-check-label" for="autoArchive">
                                Archivar expedientes completados automáticamente
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoBackup" checked>
                            <label class="form-check-label" for="autoBackup">
                                Realizar respaldos automáticos diarios
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Integraciones</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="googleCalendar" checked>
                                    <label class="form-check-label" for="googleCalendar">
                                        Google Calendar
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                    <label class="form-check-label" for="emailNotifications">
                                        Notificaciones por Email
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn-custom btn-outline-custom" onclick="resetConfig()">
                            <i class="bi bi-arrow-counterclockwise"></i> Restablecer
                        </button>
                        <button class="btn-custom btn-primary-custom" onclick="saveConfig()">
                            <i class="bi bi-check"></i> Guardar Configuración
                        </button>
                    </div>
                </div>
            </section>

            <!-- ... resto del archivo ... -->
            <!-- Nota: he actualizado etiquetas <label> a 'for' cuando había inputs con id y he convertido
                 títulos de grupo en <div class="form-label"> para evitar warnings de accesibilidad. -->
        </main>
    </div>

    <!-- Modal de Detalle de Expediente -->
    <div id="expedientModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle del Expediente</h5>
                <button class="modal-close" onclick="closeModal('expedientModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Información General</h6>
                        <p class="mb-1"><strong>Nº Expediente:</strong> <span id="viewNumExpediente"></span></p>
                        <p class="mb-1"><strong>Nº Póliza:</strong> <span id="viewNumPoliza"></span></p>
                        <p class="mb-1"><strong>Nº SGR:</strong> <span id="viewNumSGR"></span></p>
                        <p class="mb-1"><strong>Estado:</strong> <span id="viewEstado"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Datos Económicos y Fechas</h6>
                        <p class="mb-1"><strong>Importe:</strong> <span id="viewImporte"></span></p>
                        <p class="mb-1"><strong>Fecha Ocurrencia:</strong> <span id="viewFecha"></span></p>
                    </div>
                </div>
                <hr>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Asegurado</h6>
                        <p class="mb-1"><strong>Nombre:</strong> <span id="viewAsegurado"></span></p>
                        <p class="mb-1"><strong>DNI:</strong> <span id="viewDNI"></span></p>
                        <p class="mb-1"><strong>Dirección:</strong> <span id="viewDireccion"></span></p>
                        <p class="mb-1"><strong>CP:</strong> <span id="viewCP"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Siniestro</h6>
                        <p class="mb-1"><strong>Tipo Daño:</strong> <span id="viewTipoDano"></span></p>
                        <p class="mb-1"><strong>Causante:</strong> <span id="viewCausante"></span></p>
                        <p class="mb-1"><strong>Cía. Causante:</strong> <span id="viewCiaCausante"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-custom btn-outline-custom" onclick="closeModal('expedientModal')">Cerrar</button>
                <button class="btn-custom btn-primary-custom" id="btnEditExpedient">
                    <i class="bi bi-pencil"></i> Editar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edición de Expediente -->
    <div id="editExpedientModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Expediente</h5>
                <button class="modal-close" onclick="closeModal('editExpedientModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editExpedientForm" onsubmit="event.preventDefault(); saveExpedientChanges();">
                    <input type="hidden" id="editExpedientId">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="editNumSiniestro" class="form-label">Nº Siniestro</label>
                            <input type="text" class="form-control" id="editNumSiniestro" required>
                        </div>
                        <div class="col-md-4">
                            <label for="editNumPoliza" class="form-label">Nº Póliza</label>
                            <input type="text" class="form-control" id="editNumPoliza">
                        </div>
                        <div class="col-md-4">
                            <label for="editNumSGR" class="form-label">Nº SGR</label>
                            <input type="text" class="form-control" id="editNumSGR">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editEstado" class="form-label">Estado</label>
                            <select class="form-select" id="editEstado">
                                <option value="Pendiente">Pendiente</option>
                                <option value="En Proceso">En Proceso</option>
                                <option value="Pdte. revisión">Pdte. revisión</option>
                                <option value="Completado">Completado</option>
                                <option value="Archivado">Archivado</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editImporte" class="form-label">Importe (€)</label>
                            <input type="number" step="0.01" class="form-control" id="editImporte">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editAsegurado" class="form-label">Asegurado</label>
                            <input type="text" class="form-control" id="editAsegurado">
                        </div>
                        <div class="col-md-6">
                            <label for="editDNI" class="form-label">DNI</label>
                            <input type="text" class="form-control" id="editDNI">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-custom btn-outline-custom" onclick="closeModal('editExpedientModal')">Cancelar</button>
                <button class="btn-custom btn-primary-custom" onclick="saveExpedientChanges()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal de Búsqueda Avanzada -->
    <div id="advancedSearchModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Búsqueda Avanzada</h5>
                <button class="modal-close" onclick="closeModal('advancedSearchModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="advancedSearchForm" onsubmit="event.preventDefault(); performAdvancedSearch();">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Rango de Fechas (Ocurrencia)</label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="advDateStart">
                                <span class="input-group-text">a</span>
                                <input type="date" class="form-control" id="advDateEnd">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rango de Importe (€)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="advAmountMin" placeholder="Min">
                                <span class="input-group-text">-</span>
                                <input type="number" class="form-control" id="advAmountMax" placeholder="Max">
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="advStatus" class="form-label">Estado</label>
                            <select class="form-select" id="advStatus" multiple size="4">
                                <option value="">Todos</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="En Proceso">En Proceso</option>
                                <option value="Pdte. revisión">Pdte. revisión</option>
                                <option value="Completado">Completado</option>
                                <option value="Archivado">Archivado</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="advAsegurado" class="form-label">Asegurado / Cliente</label>
                            <input type="text" class="form-control" id="advAsegurado" placeholder="Nombre parcial">
                        </div>
                    </div>
                    <div class="row mb-3">
                         <div class="col-md-6">
                            <label for="advCiaCausante" class="form-label">Cía. Causante</label>
                            <input type="text" class="form-control" id="advCiaCausante" placeholder="Nombre compañía">
                        </div>
                        <div class="col-md-6">
                            <label for="advTipoDano" class="form-label">Tipo de Daño</label>
                            <input type="text" class="form-control" id="advTipoDano" placeholder="Ej: Agua, Incendio...">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-custom btn-outline-custom" onclick="closeModal('advancedSearchModal')">Cancelar</button>
                <button class="btn-custom btn-primary-custom" onclick="performAdvancedSearch()">Buscar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Nueva/Editar Tarea -->
    <div id="taskModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gestión de Tarea</h5>
                <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="event.preventDefault(); saveTask();">
                    <input type="hidden" id="taskId">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskExpedient" class="form-label">Nº Expediente / Siniestro</label>
                            <input type="text" class="form-control" id="taskExpedient" required placeholder="Ej: EXP-2024-001">
                        </div>
                        <div class="col-md-6">
                            <label for="taskResponsible" class="form-label">Responsable</label>
                            <select class="form-select" id="taskResponsible">
                                <option value="">Seleccionar...</option>
                                <!-- Se llenará dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="taskDescription" rows="3" required></textarea>
                        <div class="char-counter"><span id="char-count">0</span> caracteres</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="taskPriority" class="form-label">Prioridad</label>
                            <select class="form-select" id="taskPriority">
                                <option value="Baja">Baja</option>
                                <option value="Media" selected>Media</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="taskDueDate" class="form-label">Fecha Límite</label>
                            <input type="date" class="form-control" id="taskDueDate" required>
                        </div>
                        <div class="col-md-4">
                            <label for="taskStatus" class="form-label">Estado</label>
                            <select class="form-select" id="taskStatus">
                                <option value="Pendiente">Pendiente</option>
                                <option value="En Proceso">En Proceso</option>
                                <option value="Completada">Completada</option>
                                <option value="Pdte. revisión">Pdte. revisión</option>
                                <option value="Datos NO válidos">Datos NO válidos</option>
                                <option value="Rehusado NO cobertura">Rehusado NO cobertura</option>
                                <option value="Recobrado">Recobrado</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Opción de archivado condicional -->
                    <div id="archive-option" style="display:none;" class="alert-custom alert-warning p-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="archive-checkbox">
                            <label class="form-check-label" for="archive-checkbox">
                                <strong>Archivar expediente</strong> al guardar esta tarea
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-custom btn-outline-custom" onclick="closeModal('taskModal')">Cancelar</button>
                <button class="btn-custom btn-primary-custom" onclick="saveTask()">Guardar Tarea</button>
            </div>
        </div>
    </div>

    <!-- Modal de Usuario -->
    <div id="userModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gestión de Usuario</h5>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="event.preventDefault(); saveUser();">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="userEmail" required placeholder="usuario@gescon360.es">
                    </div>
                    <div class="mb-3">
                        <label for="userFullName" class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" id="userFullName" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="userRole" class="form-label">Rol</label>
                            <select class="form-select" id="userRole">
                                <option value="user">Usuario</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="userStatus" class="form-label">Estado</label>
                            <select class="form-select" id="userStatus">
                                <option value="active">Activo</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="alert-custom alert-info">
                        <i class="bi bi-info-circle"></i>
                        <span>Al crear un usuario, se generará una contraseña temporal que deberá ser comunicada al usuario.</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-custom btn-outline-custom" onclick="closeModal('userModal')">Cancelar</button>
                <button class="btn-custom btn-primary-custom" onclick="saveUser()">Guardar Usuario</button>
            </div>
        </div>
    </div>

    <!-- Modal de Filtrar Tareas -->
    <div id="filterTasksModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h5 class="modal-title">Filtrar Tareas</h5>
                <button class="modal-close" onclick="closeModal('filterTasksModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="filterTasksForm" onsubmit="event.preventDefault(); applyTaskFilters();">
                    <div class="mb-3">
                        <label for="filterTaskResponsible" class="form-label">Responsable</label>
                        <select class="form-select" id="filterTaskResponsible">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filterTaskStatus" class="form-label">Estado</label>
                        <select class="form-select" id="filterTaskStatus">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="En Proceso">En Proceso</option>
                            <option value="Completada">Completada</option>
                            <option value="Datos NO válidos">Datos NO válidos</option>
                            <option value="Rehusado NO cobertura">Rehusado NO cobertura</option>
                            <option value="Recobrado">Recobrado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filterTaskPriority" class="form-label">Prioridad</label>
                        <select class="form-select" id="filterTaskPriority">
                            <option value="">Todas</option>
                            <option value="Alta">Alta</option>
                            <option value="Media">Media</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-custom btn-outline-custom" onclick="clearTaskFilters()">Limpiar Filtros</button>
                <button class="btn-custom btn-primary-custom" onclick="applyTaskFilters()">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Responsable -->
    <div id="responsibleModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gestión de Responsable</h5>
                <button class="modal-close" onclick="closeModal('responsibleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="responsibleForm" onsubmit="event.preventDefault(); saveResponsible();">
                    <input type="hidden" id="respId">
                    <div class="mb-3">
                        <label for="respEmail" class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="respEmail" required placeholder="nombre@empresa.com">
                    </div>
                    <div class="mb-3">
                        <label for="respName" class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" id="respName" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="respStatus" class="form-label">Estado Operativo</label>
                            <select class="form-select" id="respStatus" onchange="toggleReturnDate()">
                                <option value="active">Disponible</option>
                                <option value="vacation">Vacaciones</option>
                                <option value="sick">Baja Médica</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="returnDateContainer" style="display: none;">
                            <label for="respReturnDate" class="form-label">Fecha de Retorno</label>
                            <input type="date" class="form-control" id="respReturnDate">
                            <small class="text-muted" style="font-size: 0.75rem;">Reactivación automática</small>
                        </div>
                        <div class="col-md-6">
                            <label for="respRole" class="form-label">Rol</label>
                            <select class="form-select" id="respRole">
                                <option value="user">Usuario</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-custom btn-outline-custom" onclick="closeModal('responsibleModal')">Cancelar</button>
                <button class="btn-custom btn-primary-custom" onclick="saveResponsible()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Reasignación Masiva de Tareas -->
    <div id="reassignTasksModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reasignación Masiva de Tareas</h5>
                <button class="modal-close" onclick="closeModal('reassignTasksModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Transfiere todas las tareas pendientes de un usuario (ej. inactivo) a otro.
                </div>
                <form id="reassignForm" onsubmit="event.preventDefault(); executeReassignment();">
                    <div class="mb-3">
                        <label for="reassignFromUser" class="form-label">Desde (Usuario Origen)</label>
                        <select class="form-select" id="reassignFromUser" required>
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reassignToUser" class="form-label">Hacia (Usuario Destino)</label>
                        <select class="form-select" id="reassignToUser" required>
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-custom btn-outline-custom" onclick="closeModal('reassignTasksModal')">Cancelar</button>
                <button class="btn-custom btn-primary-custom" onclick="executeReassignment()">Reasignar Tareas</button>
            </div>
        </div>
    </div>

 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Gestor CRUD -->
<script src="crud-manager.js"></script>
<!-- Tu script principal -->
<script src="script.js"></script>
</body>
</html>
